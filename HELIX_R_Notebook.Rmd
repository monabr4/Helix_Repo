---
title: "Examining the Impact of Environmental Exposures on Birthweight"
author: "Mona Bandov"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_folding: hide
  pdf_document:
    toc: true
---


```{css, echo=FALSE}
pre {
  max-height: 200px;
  overflow-y: auto;
}
```

```{r data setup, include=FALSE, echo=FALSE}
library(knitr)
library(summarytools) 
library(tidyverse)
library(table1)
library(dplyr)
library(here) 
library(kableExtra)
library(DT)
library(corrplot)
library(fastshap)
library(grpreg)
library(glmnet)
library(caret)
library(ggplot2)
library(lmtest)
library(nnet)
dplyr::select

options(knitr.table.format = "html")
knitr::opts_chunk$set(echo = TRUE)
old.warn <- getOption("warn")
options(warn=-1)

work.dir <- here::here()
```

HELIX.RData Download: 
```{r}
helix_file_path <- "~/Library/CloudStorage/GoogleDrive-bandov@usc.edu/.shortcut-targets-by-id/1oBvDKkpKxGnEoNogWDoXV--27W2spqKh/HELIX_data/HELIX.RData"
load(helix_file_path)
```

Metabol_serum.RData Download:
```{r}
metabol_serum_file_path <- "~/Library/CloudStorage/GoogleDrive-bandov@usc.edu/.shortcut-targets-by-id/1oBvDKkpKxGnEoNogWDoXV--27W2spqKh/HELIX_data/metabol_serum.RData"
load(metabol_serum_file_path)
```
Adjusting BMI Category 
```{r}
#Binning BMI so that predictive power increases 
phenotype <- phenotype %>%
  mutate(hs_bmi_c_cat = ifelse(hs_bmi_c_cat %in% c(1, 2), 0, 
                               ifelse(hs_bmi_c_cat %in% c(3, 4), 1, hs_bmi_c_cat)))
phenotype
```



# Abstract

This study examines the impact of environmental exposures during pregnancy on birthweight. Using data from the HELIX study, we apply ........ [INSERT MORE STUFF HERE]

Hypothesis: 

How do prenatal dietary intake and concentrations of prenatal phthalate exposures influence body mass index (BMI)  for children 6-11 years old  while controlling for  child age at examinations and gestational age at birth, and can urine metabolomics data improve predictive models of BMI using statistical and machine learning tools? [ need to edit]

# Introduction

The relationship between prenatal environmental exposures and childhood health outcomes is important, especially in understanding how prenatal factors influence long-term health in children. This data project aims to explore the influence of prenatal dietary intake and phthalate exposure concentrations on body mass index (BMI) in children aged 6 to 11 years. Phthalates, commonly found in plastics and personal care products, are known endocrine disruptors that may impact fetal development and childhood growth patterns ([Valvi et al., 2020](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8157593/)). Previous studies have shown that prenatal exposure to phthalates is associated with an increased risk of obesity and metabolic disorders in children ([Luo et al., 2020](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7559247/)). By controlling for key variables such as child age at examinations and gestational age at birth, this project seeks to examine the direct and interactive effects of these prenatal exposures on BMI.

Recent studies emphasize the important role of maternal diet during pregnancy, demonstrating that balanced maternal nutrition can mitigate the adverse effects of environmental exposures like phthalates on child BMI, suggesting that improved dietary practices during pregnancy can lead to better health outcomes for children ([NCBI, 2024](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9824240/)).

Phthalate exposure has been linked to various health issues, including obesity, type II diabetes, thyroid dysfunction, higher blood pressure, precocious puberty, and reproductive effects. It also impacts the respiratory system (allergy, asthma) and nervous system (delayed neurodevelopment, social impairment) ([Serrano et al., 2021](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7483495/)).

Furthermore, this project looks at  whether urine metabolomics data can improve predictive models of BMI using statistical and machine learning approaches. Integrating metabolomics data helps to understand the biochemical pathways linking prenatal exposures (diet and phthalates) to childhood health outcomes. This project aims to provide insights into the prevention and management of childhood obesity and related health conditions.

# Methods

[INSERT MORE STUFF HERE LATER]

## Data

The complexity of exposure to environmental contaminants has increased becuase evolving environmental and lifestyle factors. The exposome includes all environmental (non-genetic) exposures an individual encounters from conception through old age. The HELIX (Human Early-Life Exposome) project focuses on the early-life exposome, which integrates all environmental hazards that mothers and children are exposed to and linking these exposures to health, growth, and development risks.

Pregnancy and early childhood are critical times when children are more vulnerable to environmental damage, which can have lifelong effects. Understanding the exposome during these periods can help prevent diseases, since early interventions can change biological foundation and promote healthy development. HELIX cna help show how different environmental exposures together affect health outcomes and risks.

There are six existing European birth cohort studies: Born in Bradford (BiB), Etude des Déterminants pré et postnatals du développement et de la santé de l'Enfant (EDEN), INfancia y Medio Ambiente (INMA), Kaunas Cohort (KANC), Norwegian Mother, Father and Child Cohort Study (MoBa), and Rhea Mother-Child Cohort Study. These cohorts have collected extensive data from national and EU-funded projects. HELIX supplements this data with advanced tools and methods to measure and integrate the chemical, physical, and molecular environment, linking these measurements to child health outcomes.

Smartphones are utilized to measure air pollution, UV radiation, physical activity, and noise exposure. Advanced laboratory techniques identify biological markers of various chemical exposures, such as contaminants in food, consumer products, and water. HELIX has gathered extensive exposome data from mothers and children, making it the largest study on this topic. The study design is multilevel: the first level includes 31,472 mother-child pairs recruited during pregnancy across the six cohorts; the second level consists of a subcohort of 1301 mother-child pairs with detailed measurements of biomarkers, omics signatures, and health outcomes at ages 6-11 years; and the third level involves repeat-sampling panel studies with about 150 children and 150 pregnant women to collect personal exposure data.

This research focuses on a subcohort of 1301 mother-child pairs to explore questions related to environmental exposures, omic data, and their impact on health outcomes. Specifically, the project will examine urine metabolomics data with Body Mass Index (BMI) as the primary outcome of interest. The goal of this project is to provide a deeper understanding of how early-life environmental exposures influence BMI, potentially providing more information on how to apply early intervention and disease prevention.


```{r image-helix, echo=FALSE, message=FALSE, fig.align='center', fig.cap='', out.width='100%', out.width='100%'}
image_file_path <- "~/Library/CloudStorage/GoogleDrive-bandov@usc.edu/.shortcut-targets-by-id/1oBvDKkpKxGnEoNogWDoXV--27W2spqKh/HELIX_data/HELIX.png"
knitr::include_graphics(image_file_path)
```

 For more details on the study design see Vrijheid, Slama, et al. EHP 2014. see <https://www.projecthelix.eu/index.php/es/data-inventory> for more information regarding the study.

<br>


## Outcome

The primary outcome of interest is birthweight.

# Covariates

Covariates include child age, sex, and cohort.

# Exposures/Risk Factors

The main exposures of interest diet, contaminats, age, sex, and cohort

# Confounders/Interaction
[INSERT LATER]


## Model Building
[INSERT LATER]


## Model Validation
[INSERT LATER]

## Results
[INSERT LATER]

# #Discussion
[INSERT LATER]

# #Conclusions
[INSERT LATER]

# References

1. Reference 1
2. Reference 2
3. Reference 3
[INSERT LATER]

# Appendices
[INSERT LATER]


### Urine Metabolomics:

Urine metabolomics: <https://www.projecthelix.eu/files/HELIX_urine_metabol_DataSummary.pdf>\

## Data Description and Codebook


```{r}
codebook_file_path <- "~/Library/CloudStorage/GoogleDrive-bandov@usc.edu/.shortcut-targets-by-id/1oBvDKkpKxGnEoNogWDoXV--27W2spqKh/HELIX_data/HELIX.RData"
load(codebook_file_path)
#  Chemicals
filtered_codebook_chemicals <- codebook %>%
  filter(domain == "Chemicals" & 
         family == "Phthalates" & 
         period == "Pregnancy" & 
         variable_name != "hs_sumDEHP_madj_Log2")

# Covariates 
filtered_codebook_covariates <- codebook %>%
  filter(domain == "Covariates" & 
         variable_name %in% c("e3_sex_None", "h_cohort", "hs_child_age_None"))

# Phenotype
filtered_codebook_phenotype <- codebook %>%
  filter(domain == "Phenotype" & 
         variable_name %in% c("hs_bmi_c_cat"))

# Lifestyle
filtered_codebook_lifestyles <- codebook %>%
  filter(domain == "Lifestyles" & period == "Pregnancy" & subfamily == "Diet")

# Combining all the information 
combined_codebook <- bind_rows(
  filtered_codebook_chemicals,
  filtered_codebook_covariates,
  filtered_codebook_phenotype,
  filtered_codebook_lifestyles
)

# Final Display
datatable(combined_codebook, 
          options = list(pageLength = 10, 
                         autoWidth = TRUE, 
                         dom = 'Bfrtip', 
                         buttons = c('copy', 'csv', 'excel', 'pdf', 'print'), 
                         searchHighlight = TRUE),
          caption = "Filtered Codebook for HELIX Data")
```



### Data Summary Exposures: Lifestyles

```{r Lifestyles summary, attr.output='style="max-height: 100px;"',}
#Lifestyle 
filtered_codebook_lifestyles <- codebook %>%
  filter(domain == "Lifestyles" & period == "Pregnancy")
selectExposures <- filtered_codebook_lifestyles$variable_name
summarytools::view(dfSummary(exposome[,names(exposome) %in% selectExposures], 
                             style = 'grid', 
                             plain.ascii = FALSE, 
                             valid.col = FALSE, 
                             headings = FALSE), 
                   method = "render")
```


### Data Summary Exposures: Chemicals

```{r Chemicals summary, attr.output='style="max-height: 100px;"',}
#Chemical
filtered_codebook_chemicals <- codebook %>%
  filter(domain == "Chemicals" & 
         family == "Phthalates" & 
         period == "Pregnancy" & 
         variable_name != "hs_sumDEHP_madj_Log2")
selectExposures <- filtered_codebook_chemicals$variable_name
summarytools::view(dfSummary(exposome[,names(exposome) %in% selectExposures], 
                             style = 'grid', 
                             plain.ascii = FALSE, 
                             valid.col = FALSE, 
                             headings = FALSE), 
                   method = "render")
```


### Data Summary Exposures: Covariate 

```{r}
# Covariates 
filtered_codebook_covariates <- codebook %>%
  filter(variable_name %in% c("e3_sex_None", "h_cohort", "hs_child_age_None"))
selectCovariates <- filtered_codebook_covariates$variable_name
summarytools::view(dfSummary(covariates[,names(covariates) %in% selectCovariates], 
                             style = 'grid', 
                             plain.ascii = FALSE, 
                             valid.col = FALSE, 
                             headings = FALSE), 
                   method = "render")
```

### Data Summary Exposures: Phenotype

```{r}
#Figure this one out, it keeps changing.. should be 2 categories
variable_name <- "hs_bmi_c_cat"
variable_index <- which(names(phenotype) == variable_name)

summarytools::view(dfSummary(phenotype[, variable_index, drop = FALSE],
                             style = 'grid',
                             plain.ascii = FALSE,
                             valid.col = FALSE,
                             headings = FALSE),
                   method = "render")
```



## Data Exploration 


# Combining covariates with phenotype (Full Data)
```{r}
# Lifestyle variables
filtered_codebook_lifestyles <- codebook %>%
  filter(domain == "Lifestyles" & period == "Pregnancy")
selectExposures_lifestyle <- filtered_codebook_lifestyles$variable_name

# Chemical variables
filtered_codebook_chemicals <- codebook %>%
  filter(domain == "Chemicals" & family == "Phthalates" & period == "Pregnancy" & variable_name != "hs_sumDEHP_madj_Log2")
selectExposures_chemicals <- filtered_codebook_chemicals$variable_name

# Covariate variables
filtered_codebook_covariates <- codebook %>%
  filter(variable_name %in% c("e3_sex_None", "h_cohort", "hs_child_age_None"))
selectCovariates <- filtered_codebook_covariates$variable_name

# Phenotype variables
filtered_codebook_phenotype <- codebook %>%
  filter(domain == "Phenotype" & variable_name %in% c("hs_bmi_c_cat"))
selectPhenotypes <- filtered_codebook_phenotype$variable_name
all_selected_variables <- c("ID", selectExposures_lifestyle, selectExposures_chemicals, selectCovariates, selectPhenotypes, "age")

# Subset the data
subset_exposome <- exposome %>% dplyr::select(all_of(selectExposures_lifestyle), all_of(selectExposures_chemicals))
subset_covariates <- covariates %>% dplyr::select(all_of(selectCovariates))
subset_phenotype <- phenotype %>% dplyr::select(all_of(selectPhenotypes))

# Final Merge
exposome_phenotype_covariates <- exposome %>%
  dplyr::select(ID, all_of(selectExposures_lifestyle), all_of(selectExposures_chemicals)) %>%
  left_join(covariates %>% dplyr::select(ID, all_of(selectCovariates)), by = "ID") %>%
  left_join(phenotype %>% dplyr::select(ID, all_of(selectPhenotypes)), by = "ID")

# Binning BMI
exposome_phenotype_covariates <- exposome_phenotype_covariates %>%
  mutate(hs_bmi_c_cat = ifelse(hs_bmi_c_cat %in% c(1, 2), 0, 
                               ifelse(hs_bmi_c_cat %in% c(3, 4), 1, hs_bmi_c_cat)))

exposome_phenotype_covariates
```




Table by Covariates: Sex, Cohort, Age

```{r}
exposome_phenotype_covariates <- exposome_phenotype_covariates %>%
  mutate(
    e3_sex_None = factor(e3_sex_None),
    h_cohort = factor(h_cohort),
    hs_bmi_c_cat = factor(hs_bmi_c_cat))

# Labels
label(exposome_phenotype_covariates$e3_sex_None) <- "Sex"
label(exposome_phenotype_covariates$h_cohort) <- "Cohort"
label(exposome_phenotype_covariates$hs_child_age_None) <- "Child's Age"
label(exposome_phenotype_covariates$e3_alcpreg_yn_None) <- "Alcohol During Pregnancy"
label(exposome_phenotype_covariates$h_cereal_preg_Ter) <- "Cereal Intake During Pregnancy"
label(exposome_phenotype_covariates$h_dairy_preg_Ter) <- "Dairy Intake During Pregnancy"
label(exposome_phenotype_covariates$h_fastfood_preg_Ter) <- "Fast Food Intake During Pregnancy"
label(exposome_phenotype_covariates$h_fish_preg_Ter) <- "Fish Intake During Pregnancy"
label(exposome_phenotype_covariates$h_folic_t1_None) <- "Folic Acid Intake"
label(exposome_phenotype_covariates$h_fruit_preg_Ter) <- "Fruit Intake During Pregnancy"
label(exposome_phenotype_covariates$h_legume_preg_Ter) <- "Legume Intake During Pregnancy"
label(exposome_phenotype_covariates$h_meat_preg_Ter) <- "Meat Intake During Pregnancy"
label(exposome_phenotype_covariates$h_pamod_t3_None) <- "Physical Activity (Moderate)"
label(exposome_phenotype_covariates$h_pavig_t3_None) <- "Physical Activity (Vigorous)"
label(exposome_phenotype_covariates$h_veg_preg_Ter) <- "Vegetable Intake During Pregnancy"
label(exposome_phenotype_covariates$hs_mbzp_madj_Log2) <- "MBzP (Log2)"
label(exposome_phenotype_covariates$hs_mecpp_madj_Log2) <- "MECPP (Log2)"
label(exposome_phenotype_covariates$hs_mehhp_madj_Log2) <- "MEHHP (Log2)"
label(exposome_phenotype_covariates$hs_mehp_madj_Log2) <- "MEHP (Log2)"
label(exposome_phenotype_covariates$hs_meohp_madj_Log2) <- "MEOHP (Log2)"
label(exposome_phenotype_covariates$hs_mep_madj_Log2) <- "MEP (Log2)"
label(exposome_phenotype_covariates$hs_mibp_madj_Log2) <- "MiBP (Log2)"
label(exposome_phenotype_covariates$hs_mnbp_madj_Log2) <- "MnBP (Log2)"
label(exposome_phenotype_covariates$hs_ohminp_madj_Log2) <- "OH-MiNP (Log2)"
label(exposome_phenotype_covariates$hs_oxominp_madj_Log2) <- "OXO-MiNP (Log2)"
label(exposome_phenotype_covariates$hs_bmi_c_cat) <- "BMI Category"

# continuous variables
render_cont <- function(x) {
  sprintf("%.2f (%.2f)", mean(x, na.rm = TRUE), sd(x, na.rm = TRUE))
}

# categorical variables
render_cat <- function(x) {
  paste0(names(table(x)), " (", table(x), ")", collapse = ", ")
}

# Make sure its 27 columns
columns <- c("age", "hs_child_age_None", "e3_alcpreg_yn_None", "h_cereal_preg_Ter",
             "h_dairy_preg_Ter", "h_fastfood_preg_Ter", "h_fish_preg_Ter", "h_folic_t1_None",
             "h_fruit_preg_Ter", "h_legume_preg_Ter", "h_meat_preg_Ter", "h_pamod_t3_None",
             "h_pavig_t3_None", "h_veg_preg_Ter", "hs_mbzp_madj_Log2", "hs_mecpp_madj_Log2",
             "hs_mehhp_madj_Log2", "hs_mehp_madj_Log2", "hs_meohp_madj_Log2", "hs_mep_madj_Log2",
             "hs_mibp_madj_Log2", "hs_mnbp_madj_Log2", "hs_ohminp_madj_Log2", "hs_oxominp_madj_Log2")

# stratified by cohort
table1(~  hs_child_age_None  + e3_alcpreg_yn_None + h_cereal_preg_Ter + h_dairy_preg_Ter +
         h_fastfood_preg_Ter + h_fish_preg_Ter + h_folic_t1_None + h_fruit_preg_Ter +
         h_legume_preg_Ter + h_meat_preg_Ter + h_pamod_t3_None + h_pavig_t3_None +
         h_veg_preg_Ter + hs_mbzp_madj_Log2 + hs_mecpp_madj_Log2 + hs_mehhp_madj_Log2 +
         hs_mehp_madj_Log2 + hs_meohp_madj_Log2 + hs_mep_madj_Log2 + hs_mibp_madj_Log2 +
         hs_mnbp_madj_Log2 + hs_ohminp_madj_Log2 + hs_oxominp_madj_Log2 | h_cohort,
       data = exposome_phenotype_covariates,
       render.continuous = render_cont, render.categorical = render_cat,
       overall = TRUE, topclass = "Rtable1-shade")

# stratified by sex
table1(~  hs_child_age_None  + e3_alcpreg_yn_None + h_cereal_preg_Ter + h_dairy_preg_Ter +
         h_fastfood_preg_Ter + h_fish_preg_Ter + h_folic_t1_None + h_fruit_preg_Ter +
         h_legume_preg_Ter + h_meat_preg_Ter + h_pamod_t3_None + h_pavig_t3_None +
         h_veg_preg_Ter + hs_mbzp_madj_Log2 + hs_mecpp_madj_Log2 + hs_mehhp_madj_Log2 +
         hs_mehp_madj_Log2 + hs_meohp_madj_Log2 + hs_mep_madj_Log2 + hs_mibp_madj_Log2 +
         hs_mnbp_madj_Log2 + hs_ohminp_madj_Log2 + hs_oxominp_madj_Log2 | e3_sex_None,
       data = exposome_phenotype_covariates,
       render.continuous = render_cont, render.categorical = render_cat,
       overall = TRUE, topclass = "Rtable1-shade")

```



Should I do any additional tihngs with th outcome variable?

```{r}
numeric_vars <- exposome_phenotype_covariates %>%
  dplyr::select(where(is.numeric))

cor_matrix <- cor(numeric_vars, use = "complete.obs")
corrplot(cor_matrix, method = "color", type = "upper", tl.col = "black", tl.srt = 45)

find_highly_correlated <- function(cor_matrix, threshold = 0.8) {
  cor_matrix[lower.tri(cor_matrix, diag = TRUE)] <- NA  
  cor_matrix <- as.data.frame(as.table(cor_matrix)) 
  cor_matrix <- na.omit(cor_matrix)  # Remove NA values
  cor_matrix <- cor_matrix[order(-abs(cor_matrix$Freq)), ]  
  cor_matrix <- cor_matrix %>% filter(abs(Freq) > threshold)  
  return(cor_matrix)
}
#  threshold of 0.60
highly_correlated_pairs <- find_highly_correlated(cor_matrix, threshold = 0.60)
highly_correlated_pairs
```



#Correlated Variables on the outcome
```{r}
# Top 1 
ggplot(exposome_phenotype_covariates, aes(x = hs_bmi_c_cat, y = hs_mehhp_madj_Log2)) +
  geom_boxplot(outlier.shape = NA) + 
  labs(title = "Boxplot and Jitter Plot of hs_mehhp_madj_Log2 by BMI Category",
       x = "BMI Category",
       y = "hs_mehhp_madj_Log2") +
  theme_minimal()


#Top 2 
ggplot(exposome_phenotype_covariates, aes(x = hs_bmi_c_cat, y = hs_mecpp_madj_Log2)) +
  geom_boxplot(outlier.shape = NA) + 
  labs(title = "Boxplot and Jitter Plot of hs_mecpp_madj_Log2 by BMI Category",
       x = "BMI Category",
       y = "hs_mecpp_madj_Log2") +
  theme_minimal()
```



```{r}

variables <- c("e3_alcpreg_yn_None", "h_cereal_preg_Ter", "h_dairy_preg_Ter", "h_fastfood_preg_Ter",
               "h_fish_preg_Ter", "h_folic_t1_None", "h_fruit_preg_Ter", "h_legume_preg_Ter",
               "h_meat_preg_Ter", "h_pamod_t3_None", "h_pavig_t3_None", "h_veg_preg_Ter",
               "hs_mbzp_madj_Log2", "hs_mecpp_madj_Log2", "hs_mehhp_madj_Log2", "hs_mehp_madj_Log2",
               "hs_meohp_madj_Log2", "hs_mep_madj_Log2", "hs_mibp_madj_Log2", "hs_mnbp_madj_Log2",
               "hs_ohminp_madj_Log2", "hs_oxominp_madj_Log2", "e3_sex_None", "h_cohort",
               "hs_child_age_None")

plot_against_bmi_cat <- function(variable) {
  if (is.numeric(exposome_phenotype_covariates[[variable]])) {
    ggplot(exposome_phenotype_covariates, aes_string(x = "hs_bmi_c_cat", y = variable)) +
      geom_boxplot(outlier.shape = NA) +
      geom_jitter(width = 0.2, height = 0, alpha = 0.5, color = "blue") +
      labs(title = paste("Boxplot and Jitter Plot of", variable, "by hs_bmi_c_cat"),
           x = "BMI Category",
           y = variable) +
      theme_minimal()
  } else {
    ggplot(exposome_phenotype_covariates, aes_string(x = "hs_bmi_c_cat", fill = variable)) +
      geom_bar(position = "dodge") +
      labs(title = paste("Bar Plot of", variable, "by hs_bmi_c_cat"),
           x = "BMI Category",
           y = "Count") +
      theme_minimal()
  }
}

plots <- lapply(variables, plot_against_bmi_cat)
for (plot in plots) {
  print(plot)
}

```



# Data Modeling 

Lasso Ridge Regression (For Log)
BMI 

0- Undereweight and Normal 
1- Overweight and Obese


## Model 1: Grouped Lasso Logistic Regression (With Important Variables) without Metabolomics Data 

# Finding the most important variables:

#Sub Models: 


Data Prep
```{r}

exposome_phenotype_covariates <- exposome_phenotype_covariates %>%
  mutate(across(c("h_cereal_preg_Ter", "h_dairy_preg_Ter", "h_fastfood_preg_Ter",
                  "h_fish_preg_Ter", "h_folic_t1_None", "h_fruit_preg_Ter", 
                  "h_legume_preg_Ter", "h_meat_preg_Ter", "h_veg_preg_Ter",
                  "hs_mbzp_madj_Log2", "hs_mecpp_madj_Log2", "hs_mehhp_madj_Log2",
                  "hs_mehp_madj_Log2", "hs_meohp_madj_Log2", "hs_mep_madj_Log2", 
                  "hs_mibp_madj_Log2", "hs_mnbp_madj_Log2", "hs_ohminp_madj_Log2",
                  "hs_oxominp_madj_Log2", "e3_alcpreg_yn_None", "e3_sex_None", 
                  "h_cohort", "hs_child_age_None"), as.numeric))


X_dietary <- as.matrix(exposome_phenotype_covariates[, c("h_cereal_preg_Ter", "h_dairy_preg_Ter", "h_fastfood_preg_Ter", "h_fish_preg_Ter", "h_folic_t1_None", "h_fruit_preg_Ter", 
"h_legume_preg_Ter", "h_meat_preg_Ter", "h_veg_preg_Ter")])

X_phthalates <- as.matrix(exposome_phenotype_covariates[, c("hs_mbzp_madj_Log2", "hs_mecpp_madj_Log2", "hs_mehhp_madj_Log2", "hs_mehp_madj_Log2", "hs_meohp_madj_Log2", "hs_mep_madj_Log2", "hs_mibp_madj_Log2", "hs_mnbp_madj_Log2", "hs_ohminp_madj_Log2", "hs_oxominp_madj_Log2")])

X_combined <- as.matrix(exposome_phenotype_covariates[, c("h_cereal_preg_Ter", "h_dairy_preg_Ter", "h_fastfood_preg_Ter", "h_fish_preg_Ter", "h_folic_t1_None", "h_fruit_preg_Ter", "h_legume_preg_Ter", "h_meat_preg_Ter", "h_veg_preg_Ter",
"hs_mbzp_madj_Log2", "hs_mecpp_madj_Log2", "hs_mehhp_madj_Log2", "hs_mehp_madj_Log2", "hs_meohp_madj_Log2", "hs_mep_madj_Log2", "hs_mibp_madj_Log2", "hs_mnbp_madj_Log2", "hs_ohminp_madj_Log2", "hs_oxominp_madj_Log2", "e3_alcpreg_yn_None", "e3_sex_None", "h_cohort", "hs_child_age_None")])

y <- as.numeric(as.character(exposome_phenotype_covariates$hs_bmi_c_cat))

```

Fit Grouped Lasso

```{r}
# Fit Grouped Lasso models
model_dietary <- grpreg(X_dietary, y, group = rep(1:9, each = 1), family = "binomial")
model_phthalates <- grpreg(X_phthalates, y, group = rep(1:10, each = 1), family = "binomial")
model_combined <- grpreg(X_combined, y, group = c(rep(1:9, each = 1), rep(10:19, each = 1), rep(20:23, each = 1)), family = "binomial")

```

CV to get the best Lambda 
```{r}
cv_dietary <- cv.grpreg(X_dietary, y, group = rep(1:9, each = 1), family = "binomial", nfolds = 10)
cv_phthalates <- cv.grpreg(X_phthalates, y, group = rep(1:10, each = 1), family = "binomial", nfolds = 10)
cv_combined <- cv.grpreg(X_combined, y, group = c(rep(1:9, each = 1), rep(10:19, each = 1), rep(20:23, each = 1)), family = "binomial", nfolds = 10)

best_lambda_dietary <- cv_dietary$lambda.min
best_lambda_phthalates <- cv_phthalates$lambda.min
best_lambda_combined <- cv_combined$lambda.min

cat("Best lambda for dietary model:", best_lambda_dietary, "\n")
cat("Best lambda for phthalates model:", best_lambda_phthalates, "\n")
cat("Best lambda for combined model:", best_lambda_combined, "\n")

plot(cv_dietary, main = "Cross-validation for Dietary Model")
plot(cv_phthalates, main = "Cross-validation for Phthalates Model")
plot(cv_combined, main = "Cross-validation for Combined Model")
```

Train Model and Calc Accuracy:
```{r}
model_dietary_final <- grpreg(X_dietary, y, group = rep(1:9, each = 1), family = "binomial", lambda = best_lambda_dietary)
model_phthalates_final <- grpreg(X_phthalates, y, group = rep(1:10, each = 1), family = "binomial", lambda = best_lambda_phthalates)
model_combined_final <- grpreg(X_combined, y, group = c(rep(1:9, each = 1), rep(10:19, each = 1), rep(20:23, each = 1)), family = "binomial", lambda = best_lambda_combined)

pred_dietary <- predict(model_dietary_final, X_dietary, type = "response") > 0.5
pred_phthalates <- predict(model_phthalates_final, X_phthalates, type = "response") > 0.5
pred_combined <- predict(model_combined_final, X_combined, type = "response") > 0.5

accuracy_dietary <- mean(pred_dietary == y)
accuracy_phthalates <- mean(pred_phthalates == y)
accuracy_combined <- mean(pred_combined == y)

cat("Accuracy for dietary model:", accuracy_dietary, "\n")
cat("Accuracy for phthalates model:", accuracy_phthalates, "\n")
cat("Accuracy for combined model:", accuracy_combined, "\n")
```

Variable Importnace:

```{r}
# Extracting non-zero coef
extract_nonzero_coefficients <- function(model, variable_names) {
  coefs <- coef(model)
  nonzero_indices <- which(coefs != 0)
  nonzero_coefs <- coefs[nonzero_indices]
  nonzero_variable_names <- c("(Intercept)", variable_names)[nonzero_indices]
  return(data.frame(Variable = nonzero_variable_names, Coefficient = nonzero_coefs))
}

# dietary model
dietary_variable_names <- c("h_cereal_preg_Ter", "h_dairy_preg_Ter", "h_fastfood_preg_Ter", 
                            "h_fish_preg_Ter", "h_folic_t1_None", "h_fruit_preg_Ter", 
                            "h_legume_preg_Ter", "h_meat_preg_Ter", "h_veg_preg_Ter")

#  phthalates model
phthalates_variable_names <- c("hs_mbzp_madj_Log2", "hs_mecpp_madj_Log2", "hs_mehhp_madj_Log2", 
                               "hs_mehp_madj_Log2", "hs_meohp_madj_Log2", "hs_mep_madj_Log2", 
                               "hs_mibp_madj_Log2", "hs_mnbp_madj_Log2", "hs_ohminp_madj_Log2", 
                               "hs_oxominp_madj_Log2")

# combined model
combined_variable_names <- c("h_cereal_preg_Ter", "h_dairy_preg_Ter", "h_fastfood_preg_Ter", 
                             "h_fish_preg_Ter", "h_folic_t1_None", "h_fruit_preg_Ter", 
                             "h_legume_preg_Ter", "h_meat_preg_Ter", "h_veg_preg_Ter")
```

```{r}
important_variables_dietary <- extract_nonzero_coefficients(model_dietary_final, dietary_variable_names)
important_variables_phthalates <- extract_nonzero_coefficients(model_phthalates_final, phthalates_variable_names)
important_variables_combined <- extract_nonzero_coefficients(model_combined_final, combined_variable_names)

cat("Important variables for the dietary model:\n")
print(important_variables_dietary)

cat("\nImportant variables for the phthalates model:\n")
print(important_variables_phthalates)

cat("\nImportant variables for the combined model:\n")
print(important_variables_combined)
```

## Model 2: Grouped Lasso Full Model +  Metabolomics Data 


## Model 3: Best MOdel + Metabolomics Data 
```{r}
#exposome_phenotype_covariates 
#metabol_serum.d
#Attaching Serium 
```

https://stat.ethz.ch/Manuscripts/buhlmann/logistic-grouplasso-final.pdf
https://cran.r-project.org/web/packages/grplasso/grplasso.pdf








